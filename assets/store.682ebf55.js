import{W as e,g as s,aB as n,G as i,aC as o,a1 as t,s as a,j as r,aD as u,ab as l,aw as d,aa as c,Y as g,V as p}from"./index-6d8df4d2.js";const f=e.importObject("uni-id-co"),h=e.database().collection("uni-id-users");let I=s("uni-id-pages-userInfo")||{};const w={async updateUserInfo(s=!1){if(s)h.where("_id==$env.uid").update(s).then((e=>{e.result.updated?(i({title:"更新成功",icon:"none",duration:3e3}),this.setUserInfo(s)):i({title:"没有改变",icon:"none",duration:3e3})}));else{const s=e.importObject("uni-id-co",{customUI:!0});try{let e=await h.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file").get();const n=await s.getRealNameInfo();this.setUserInfo({...e.result.data[0],realNameAuth:n})}catch(n){this.setUserInfo({},{cover:!0}),console.error(n.message,n.errCode)}}},async setUserInfo(e,{cover:s}={cover:!1}){let n=s?e:Object.assign(m.userInfo,e);return m.userInfo=Object.assign({},n),m.hasLogin=0!=Object.keys(m.userInfo).length,o({key:"uni-id-pages-userInfo",data:m.userInfo}),e},async logout(){var s;if(e.getCurrentUserInfo().tokenExpired>Date.now())try{await f.logout()}catch(n){console.error(n)}t("uni_id_token"),a("uni_id_token_expired",0),r({url:`/${(null==(s=u.uniIdRouter)?void 0:s.loginPage)??"uni_modules/uni-id-pages/pages/login/login-withoutpwd"}`}),l("uni-id-pages-logout"),this.setUserInfo({},{cover:!0})},loginBack(e={}){const{uniIdRedirectUrl:s=""}=e;let n=0,i=d();if(i.forEach(((e,s)=>{"login"==i[i.length-s-1].route.split("/")[3]&&n++})),s)return c({url:s});if("weixin"==e.loginType)return window.history.go(-3);if(n){const e=u.pages[0];return c({url:`/${e.path}`})}g({delta:n})},loginSuccess(e={}){const{showToast:s=!0,toastText:n="登录成功",autoBack:o=!0,uniIdRedirectUrl:t="",passwordConfirmed:a}=e;if(s&&i({title:n,icon:"none",duration:3e3}),this.updateUserInfo(),l("uni-id-pages-login-success"),p.setPasswordAfterLogin&&!a)return r({url:t?`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${t}&loginType=${e.loginType}`:`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${e.loginType}`,fail:e=>{console.log(e)}});o&&this.loginBack({uniIdRedirectUrl:t})}},m=n({userInfo:I,hasLogin:0!=Object.keys(I).length});export{w as m,m as s};
