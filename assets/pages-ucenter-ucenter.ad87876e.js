import{M as e,N as t,W as s,_ as i,G as n,p as o,q as a,L as l,v as r,o as d,c,w as u,d as h,e as g,t as _,a as p,F as f,r as m,n as y,D as k,i as w,f as I,l as x,O as L,P as b,C}from"./index-6d8df4d2.js";import{_ as v}from"./uni-popup.4ce3ad51.js";import{_ as S}from"./cloud-image.87c70ce7.js";import{s as F}from"./store.682ebf55.js";const $="RewardedVideo",A="FullScreenVideo";const E="csj";class R{constructor(e,t={}){this._isLoad=!1,this._isLoading=!1,this._lastLoadTime=0,this._lastError=null,this._retryCount=0,this._loadCallback=null,this._closeCallback=null,this._errorCallback=null;const s=this._ad=e;s.onLoad((e=>{this._isLoading=!1,this._isLoad=!0,this._lastLoadTime=Date.now(),this.onLoad()})),s.onClose((e=>{this._isLoad=!1,this.onClose(e)})),s.onVerify&&s.onVerify((e=>{})),s.onError((({code:e,message:t})=>{this._isLoading=!1;const s={code:e,errMsg:t};if(-5008!==e){if(this._retryCount<1)return this._retryCount+=1,void this._loadAd();this._lastError=s,this.onError(s)}else this._loadAd()}))}get isExpired(){return 0!==this._lastLoadTime&&Math.abs(Date.now()-this._lastLoadTime)>18e5}get isLoading(){return this._isLoading}getProvider(){return this._ad.getProvider()}load(e,t){this._loadCallback=e,this._errorCallback=t,this._isLoading||(this._isLoad?this.onLoad():(this._retryCount=0,this._loadAd()))}show(e){if(this._closeCallback=e,this._isLoading||!this._isLoad)return;if(null!==this._lastError)return void this.onError(this._lastError);this.getProvider()===E&&this.isExpired?this._loadAd():this._ad.show()}onLoad(e){null!=this._loadCallback&&this._loadCallback()}onClose(e){null!=this._closeCallback&&this._closeCallback({isEnded:e.isEnded})}onError(e){null!=this._errorCallback&&this._errorCallback(e)}destroy(){this._ad.destroy()}_loadAd(){this._isLoad=!1,this._isLoading=!0,this._lastError=null,this._ad.load()}}class T extends R{constructor(e={}){super(plus.ad.createRewardedVideoAd(e),e)}}class D extends R{constructor(e={}){super(plus.ad.createFullScreenVideoAd(e),e)}}const V=new class{constructor(){this._ads={}}load(e,t,s){let i=this._fixOldOptions(e),{adpid:n}=i;n&&!this.isBusy(n)&&this.get(i).load(t,s)}show(s,i,n){let o=this._fixOldOptions(s),{adpid:a}=o;if(a){e({mask:!0});var l=this.get(o);l.load((()=>{t(),l.show((e=>{i&&i(e)}))}),(e=>{t(),n&&n(e)}))}}isBusy(e){return this._ads[e]&&this._ads[e].isLoading}get(e){const{adpid:t,singleton:s=!0}=e;return!1===s&&this._ads[t]&&(this._ads[t].destroy(),delete this._ads[t]),delete e.singleton,this._ads[t]||(this._ads[t]=this._createAdInstance(e)),this._ads[t]}_createAdInstance(e){const t=e.adType||$;delete e.adType;let s=null;return t===$?s=new T(e):t===A&&(s=new D(e)),s}_fixOldOptions(e){return"string"==typeof e?{adpid:e}:e}},M=s.database().action("signIn").collection("opendb-sign-in");new Date((new Date).toLocaleDateString()).getTime();const O=i({name:"uni-signIn",data:()=>({total:0,scores:0,weekdays:[1,2,3,4,5,6,7],signInRes:{days:[],n:0}}),mounted(){},methods:{async getSignedInInfo(e="今日已签过"){const t=new Date((new Date).toLocaleDateString()).getTime();let s=await M.where(`'user_id' == $env.uid && 'date' == ${t} && 'isDelete' == false`).get();return s.result.data.length&&(this.signInRes=s.result,this.$refs.popup.open(),n({title:e,duration:3e3,icon:"none"})),s.result.data},async showRewardedVideoAd(){let i=await this.getSignedInInfo();if(console.log(i),i&&0==i.length){let i=s.getCurrentUserInfo().uid;if(!i)return o({url:"/pages/ucenter/login-page/index/index"});V.show({adpid:1733738477,adType:"RewardedVideo",urlCallback:{userId:i,extra:"uniSignIn"}},(s=>{if(s&&s.isEnded){console.log("onClose "+s.isEnded);let i=0;e({mask:!0});let o=setInterval((async e=>{i++,s=await this.getSignedInInfo("签到成功"),(i>2||s.length)&&(s.length||n({title:"签到失败！",icon:"error",duration:6e3}),clearInterval(o),t())}),2e3)}else console.log("onClose "+s.isEnded),n({title:"播放中途退出,签到失败！",icon:"error",duration:5e3})}),(e=>{console.log(e),n({title:e.errMsg,icon:"none"})}))}},async open(){e({mask:!0});try{let e=await this.getSignedInInfo();if(e&&0==e.length){let e=await M.add({});console.log(e),t(),this.signInRes=e.result,this.$refs.popup.open(),7==this.signInRes.days.length?n({title:"你已完成7日连续签到，获得60积分！",icon:"none",duration:5e3}):n({title:"签到成功,获得10积分！",icon:"none",duration:5e3})}}catch(s){t(),console.error(s)}},closeMe(e){this.$refs.popup.close()}}},[["render",function(e,t,s,i,n,o){const x=k,L=w,b=I,C=a(r("uni-icons"),l),S=a(r("uni-popup"),v);return d(),c(b,null,{default:u((()=>[h(S,{ref:"popup",type:"center"},{default:u((()=>[h(x,{class:"background-img",src:"/assets/background-42813c32.png",mode:"width"}),h(b,{class:"content"},{default:u((()=>[h(b,{class:"main"},{default:u((()=>[h(L,{class:"title"},{default:u((()=>[g("今日签到成功")])),_:1}),h(L,{class:"total"},{default:u((()=>[g("本轮已签到"+_(n.signInRes.days.length)+"天",1)])),_:1}),h(L,{class:"scores"},{default:u((()=>[g("当前积分："+_(n.signInRes.score),1)])),_:1})])),_:1}),h(b,null,{default:u((()=>[h(b,{class:"days-box"},{default:u((()=>[(d(!0),p(f,null,m(n.weekdays,((e,t)=>(d(),c(b,{class:"days",key:t},{default:u((()=>[n.signInRes.days.includes(e-1)?(d(),c(C,{key:0,class:"icon active",color:"#FFFFFF",type:"checkmarkempty"})):(d(),p(f,{key:1},[e<n.signInRes.n?(d(),c(C,{key:0,class:"icon active",color:"#FFFFFF",type:"closeempty"})):(d(),c(C,{key:1,class:"icon",type:"checkmarkempty",color:"#FFFFFF"}))],64)),n.signInRes.days.includes(e-1)||e>n.signInRes.n?(d(),c(L,{key:2,class:y(["day",{grey:e>n.signInRes.n}])},{default:u((()=>[g("第"+_(e)+"天",1)])),_:2},1032,["class"])):(d(),c(L,{key:3,class:"day"},{default:u((()=>[g("缺卡")])),_:1}))])),_:2},1024)))),128))])),_:1}),h(b,{class:"tip-box"},{default:u((()=>[h(L,{class:"tip"},{default:u((()=>[g("签到一次得10积分")])),_:1}),h(b,{class:"row"},{default:u((()=>[h(L,{class:"tip"},{default:u((()=>[g("连续签到7天可多得")])),_:1}),h(L,{class:"red"},{default:u((()=>[g("50")])),_:1}),h(L,{class:"tip"},{default:u((()=>[g("积分")])),_:1})])),_:1})])),_:1})])),_:1}),h(C,{onClick:o.closeMe,class:"close-icon",type:"closeempty",size:"20",color:"#AAAAAA"},null,8,["onClick"])])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-3d6dcfc5"]]);const j=s.database();const B=i({data(){return{gridList:[{text:this.$t("mine.showText"),icon:"chat"},{text:this.$t("mine.showText"),icon:"cloud-upload"},{text:this.$t("mine.showText"),icon:"contact"},{text:this.$t("mine.showText"),icon:"download"}],ucenterList:[[{title:this.$t("mine.signIn"),event:"signIn",icon:"compose"},{title:this.$t("mine.myScore"),to:"",event:"getScore",icon:"paperplane"}],[{title:this.$t("mine.feedback"),to:"/uni_modules/uni-feedback/pages/opendb-feedback/opendb-feedback",icon:"help"},{title:this.$t("mine.settings"),to:"/pages/ucenter/settings/settings",icon:"gear"}]],listStyles:{height:"150rpx",width:"150rpx",border:{color:"#eee",width:"1px",style:"solid",radius:"100%"}},cesuanShow:!0}},onLoad(){this.cesuanShow=x().globalData.ceSuanShow},onShow(){},computed:{userInfo:()=>F.userInfo,hasLogin:()=>F.hasLogin,appConfig:()=>x().globalData.config},methods:{openXiuXin(){this.hasLogin?o({url:"/pages/xiuxin/xiuxinRecord"}):o({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"})},toSettings(){o({url:"/pages/ucenter/settings/settings"})},signIn(){this.$refs.signIn.open()},signInByAd(){this.$refs.signIn.showRewardedVideoAd()},ucenterListClick(e){console.log(e.event),!e.to&&e.event&&this[e.event]()},async checkVersion(){let e=await new Promise(((e,t)=>{t({message:"请在App中使用"})}));console.log(e),e.result.code},toUserInfo(){this.hasLogin?o({url:"/uni_modules/uni-id-pages/pages/userinfo/userinfo"}):o({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"})},tapGrid(e){n({title:this.$t("mine.clicked")+" "+(e+1),icon:"none"})},gotoMarket(){},getScore(){if(!this.userInfo)return n({title:this.$t("mine.checkScore"),icon:"none"});e({mask:!0}),j.collection("uni-id-scores").where('"user_id" == $env.uid').field("score,balance").orderBy("create_date","desc").limit(1).get().then((e=>{console.log(e);const t=e.result.data[0];let s="";s=t?this.$t("mine.currentScore")+t.balance:this.$t("mine.noScore"),n({title:s,icon:"none"})})).finally((()=>{t()}))},async share(){let{result:e}=await j.collection("uni-id-users").where("'_id' == $cloudEnv_uid").field("my_invite_code").get(),t=e.data[0].my_invite_code;if(!t)return n({title:"请检查uni-config-center中uni-id配置，是否已启用 autoSetInviteCode",icon:"none"});console.log({myInviteCode:t}),this.appConfig.about}}},[["render",function(e,t,s,i,n,o){const l=a(r("uni-sign-in"),O),y=a(r("cloud-image"),S),x=k,v=w,F=I,$=a(r("uni-list-item"),L),A=a(r("uni-list"),b);return d(),c(F,{class:"center"},{default:u((()=>[h(l,{ref:"signIn"},null,512),h(F,{class:"userInfo",onClick:o.toUserInfo},{default:u((()=>[o.hasLogin&&o.userInfo.avatar_file&&o.userInfo.avatar_file.url?(d(),c(y,{key:0,width:"150rpx",height:"150rpx",src:o.userInfo.avatar_file.url},null,8,["src"])):(d(),c(x,{key:1,class:"logo-img",src:"/assets/defaultAvatarUrl-558f5b7b.png"})),h(F,{class:"logo-title"},{default:u((()=>[o.hasLogin?(d(),c(v,{key:0,class:"uer-name"},{default:u((()=>[g(_(o.userInfo.nickname||o.userInfo.username||o.userInfo.mobile),1)])),_:1})):(d(),c(v,{key:1,class:"uer-name"},{default:u((()=>[g(_(e.$t("mine.notLogged")),1)])),_:1}))])),_:1})])),_:1},8,["onClick"]),(d(!0),p(f,null,m(n.ucenterList,((e,t)=>(d(),c(A,{class:"center-list",key:t},{default:u((()=>[(d(!0),p(f,null,m(e,((e,t)=>(d(),c($,{title:e.title,link:"",rightText:e.rightText,key:t,clickable:!0,to:e.to,onClick:t=>o.ucenterListClick(e),"show-extra-icon":!0,extraIcon:{type:e.icon,color:"#999"}},{footer:u((()=>[e.showBadge?(d(),c(F,{key:0,class:"item-footer"},{default:u((()=>[h(v,{class:"item-footer-text"},{default:u((()=>[g(_(e.rightText),1)])),_:2},1024),h(F,{class:"item-footer-badge"})])),_:2},1024)):C("",!0)])),_:2},1032,["title","rightText","to","onClick","extraIcon"])))),128))])),_:2},1024)))),128))])),_:1})}],["__scopeId","data-v-a41621c0"]]);export{B as default};
