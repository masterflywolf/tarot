import{_ as e,k as i,M as t,W as a,N as s,p as o,ao as n,q as l,v as u,L as r,o as c,c as d,w as p,b as h,n as m,a4 as f,at as g,d as y,e as b,i as w,f as _,G as v,C as k,a as I,F as C,O as x,P as M}from"./index-6d8df4d2.js";import{_ as S}from"./cloud-image.87c70ce7.js";import{s as P,m as B}from"./store.682ebf55.js";import{_ as N}from"./uni-popup-dialog.aa82751c.js";import{_ as A}from"./uni-popup.4ce3ad51.js";const L=e({data:()=>({isPC:!1}),props:{width:{type:String,default:()=>"50px"},height:{type:String,default:()=>"50px"},border:{type:Boolean,default:()=>!1}},async mounted(){this.isPC=!["ios","android"].includes(i().platform)},computed:{hasLogin:()=>P.hasLogin,userInfo:()=>P.userInfo,avatar_file:()=>P.userInfo.avatar_file},methods:{setAvatarFile(e){B.updateUserInfo({avatar_file:e})},async bindchooseavatar(e){let i=e.detail.avatarUrl,o={extname:i.split(".")[i.split(".").length-1],name:"",url:""},n=this.userInfo._id+""+Date.now();o.name=n;try{t({title:"更新中",mask:!0});let{fileID:e}=await a.uploadFile({filePath:i,cloudPath:n,fileType:"image"});o.url=e,s()}catch(l){console.error(l)}console.log("avatar_file",o),this.setAvatarFile(o)},uploadAvatarImg(e){if(!this.hasLogin)return o({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"});const i={quality:100,width:600,height:600,resize:!0};n({count:1,crop:i,success:async e=>{let n=e.tempFiles[0],l={extname:n.name.split(".")[n.name.split(".").length-1]},u=e.tempFilePaths[0];u=await new Promise((e=>{this.isPC||o({url:"/uni_modules/uni-id-pages/pages/userinfo/cropImage/cropImage?path="+u+`&options=${JSON.stringify(i)}`,animationType:"fade-in",events:{success:i=>{e(i)}},complete(e){}})}));let r=this.userInfo._id+""+Date.now();l.name=r,t({title:"更新中",mask:!0});let{fileID:c}=await a.uploadFile({filePath:u,cloudPath:r,fileType:"image"});l.url=c,s(),this.setAvatarFile(l)}})}}},[["render",function(e,i,t,a,s,o){const n=l(u("cloud-image"),S),g=l(u("uni-icons"),r),y=f;return c(),d(y,{"open-type":"chooseAvatar",onChooseavatar:o.bindchooseavatar,onClick:o.uploadAvatarImg,class:m(["box",{showBorder:t.border}]),style:h({width:t.width,height:t.height,lineHeight:t.height})},{default:p((()=>[o.avatar_file?(c(),d(n,{key:0,src:o.avatar_file.url,width:t.width,height:t.height},null,8,["src","width","height"])):(c(),d(g,{key:1,style:h({width:t.width,height:t.height,lineHeight:t.height}),class:"chooseAvatar",type:"plusempty",size:"30",color:"#dddddd"},null,8,["style"]))])),_:1},8,["onChooseavatar","onClick","class","style"])}],["__scopeId","data-v-4cd0367b"]]);a.database().collection("uni-id-users");const T=a.importObject("uni-id-co");const j=e({emits:["success"],computed:{},data:()=>({}),methods:{beforeGetphonenumber:async()=>await new Promise(((e,i)=>{t({mask:!0}),wx.checkSession({success(){e(),s()},fail(){g({success({code:t}){a.importObject("uni-id-co",{customUI:!0}).loginByWeixin({code:t}).then((i=>{e()})).catch((e=>{console.log(e),i()})).finally((e=>{s()}))},fail:e=>{console.error(e),i()}})}})})),async bindMobileByMpWeixin(e){"getPhoneNumber:ok"==e.detail.errMsg?(await this.beforeGetphonenumber(),T.bindMobileByMpWeixin(e.detail).then((e=>{this.$emit("success")})).finally((e=>{this.closeMe()}))):this.closeMe()},async open(){this.$refs.popup.open()},closeMe(e){this.$refs.popup.close()}}},[["render",function(e,i,t,a,s,o){const n=w,r=f,h=_,m=l(u("uni-popup"),A);return c(),d(m,{ref:"popup",type:"bottom"},{default:p((()=>[y(h,{class:"box"},{default:p((()=>[y(n,{class:"headBox"},{default:p((()=>[b("绑定资料")])),_:1}),y(n,{class:"tip"},{default:p((()=>[b("将一键获取你的手机号码绑定你的个人资料")])),_:1}),y(h,{class:"btnBox"},{default:p((()=>[y(n,{onClick:o.closeMe,class:"close"},{default:p((()=>[b("关闭")])),_:1},8,["onClick"]),y(r,{class:"agree uni-btn",type:"primary","open-type":"getPhoneNumber",onGetphonenumber:o.bindMobileByMpWeixin},{default:p((()=>[b("获取")])),_:1},8,["onGetphonenumber"])])),_:1})])),_:1})])),_:1},512)}],["__scopeId","data-v-1edc5089"]]),F=a.importObject("uni-id-co");const U=e({computed:{userInfo:()=>P.userInfo,realNameStatus(){return this.userInfo.realNameAuth?this.userInfo.realNameAuth.authStatus:0}},data:()=>({univerifyStyle:{authButton:{title:"本机号码一键绑定"},otherLoginButton:{title:"其他号码绑定"}},hasPwd:!1,showLoginManage:!1,setNicknameIng:!1}),async onShow(){this.univerifyStyle.authButton.title="本机号码一键绑定",this.univerifyStyle.otherLoginButton.title="其他号码绑定"},async onLoad(e){e.showLoginManage&&(this.showLoginManage=!0);let i=await F.getAccountInfo();this.hasPwd=i.isPasswordSet},methods:{login(){o({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd",complete:e=>{}})},logout(){B.logout()},bindMobileSuccess(){B.updateUserInfo()},changePassword(){o({url:"/uni_modules/uni-id-pages/pages/userinfo/change_pwd/change_pwd",complete:e=>{}})},bindMobile(){this.bindMobileBySmsCode()},univerify(){g({provider:"univerify",univerifyStyle:this.univerifyStyle,success:async e=>{F.bindMobileByUniverify(e.authResult).then((e=>{B.updateUserInfo()})).catch((e=>{console.log(e)})).finally((e=>{uni.closeAuthView()}))},fail:e=>{console.log(e),"30002"!=e.code&&"30001"!=e.code||this.bindMobileBySmsCode()}})},bindMobileBySmsCode(){o({url:"./bind-mobile/bind-mobile"})},setNickname(e){e?(B.updateUserInfo({nickname:e}),this.setNicknameIng=!1,this.$refs.dialog.close()):this.$refs.dialog.open()},deactivate(){o({url:"/uni_modules/uni-id-pages/pages/userinfo/deactivate/deactivate"})},async bindThirdAccount(e){const i=a.importObject("uni-id-co"),t={weixin:"wx_openid",alipay:"ali_openid",apple:"apple_openid",qq:"qq_openid"}[e.toLowerCase()];this.userInfo[t]?(await i["unbind"+e](),await B.updateUserInfo()):g({provider:e.toLowerCase(),onlyAuthorize:!0,success:async t=>{const a=await i["bind"+e]({code:t.code});a.errCode&&v({title:a.errMsg||"绑定失败",duration:3e3}),await B.updateUserInfo()},fail:async e=>{console.log(e),s()}})},realNameVerify(){o({url:"/uni_modules/uni-id-pages/pages/userinfo/realname-verify/realname-verify"})}}},[["render",function(e,i,t,a,s,o){const n=l(u("uni-id-pages-avatar"),L),r=_,h=l(u("uni-list-item"),x),m=l(u("uni-list"),M),g=l(u("uni-popup-dialog"),N),w=l(u("uni-popup"),A),v=l(u("uni-id-pages-bind-mobile"),j),S=f;return c(),d(r,{class:"uni-content"},{default:p((()=>[y(r,{class:"avatar"},{default:p((()=>[y(n,{width:"260rpx",height:"260rpx"})])),_:1}),y(m,null,{default:p((()=>[y(h,{class:"item",onClick:i[0]||(i[0]=e=>o.setNickname("")),title:"昵称",rightText:o.userInfo.nickname||"未设置",link:""},null,8,["rightText"]),y(h,{class:"item",onClick:o.bindMobile,title:"手机号",rightText:o.userInfo.mobile||"未绑定",link:""},null,8,["onClick","rightText"]),o.userInfo.email?(c(),d(h,{key:0,class:"item",title:"电子邮箱",rightText:o.userInfo.email},null,8,["rightText"])):k("",!0),s.hasPwd?(c(),d(h,{key:1,class:"item",onClick:o.changePassword,title:"修改密码",link:""},null,8,["onClick"])):k("",!0)])),_:1}),y(m,{class:"mt10"},{default:p((()=>[y(h,{onClick:o.deactivate,title:"注销账号",link:"navigateTo"},null,8,["onClick"])])),_:1}),y(w,{ref:"dialog",type:"dialog"},{default:p((()=>[y(g,{mode:"input",value:o.userInfo.nickname,onConfirm:o.setNickname,inputType:s.setNicknameIng?"nickname":"text",title:"设置昵称",placeholder:"请输入要设置的昵称"},null,8,["value","onConfirm","inputType"])])),_:1},512),y(v,{ref:"bind-mobile-by-sms",onSuccess:o.bindMobileSuccess},null,8,["onSuccess"]),s.showLoginManage?(c(),I(C,{key:0},[o.userInfo._id?(c(),d(S,{key:0,onClick:o.logout},{default:p((()=>[b("退出登录")])),_:1},8,["onClick"])):(c(),d(S,{key:1,onClick:o.login},{default:p((()=>[b("去登录")])),_:1},8,["onClick"]))],64)):k("",!0)])),_:1})}],["__scopeId","data-v-a98497c8"]]);export{U as default};
